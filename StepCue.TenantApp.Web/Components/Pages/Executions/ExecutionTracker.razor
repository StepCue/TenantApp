@page "/executions/{Id:int}"
@page "/executions/create/{PlanId:int}"
@using StepCue.TenantApp.Core.Services
@using StepCue.TenantApp.Data.Models
@using StepCue.TenantApp.Data.Models.Execution
@using StepCue.TenantApp.Data.Models.Planning
@using StepCue.TenantApp.Web.Services
@using StepCue.TenantApp.Web.Components.Shared
@inject ExecutionService ExecutionService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Execution Tracker</PageTitle>

@if (_execution == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <ExecutionTimelineHeader 
        Execution="@_execution"
        CurrentStepId="@_currentStep?.Id"
        OnStepClick="@HandleTimelineStepClick" />
    
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-2">
        <MudText Typo="Typo.h4" Class="mb-1">@_execution.Name</MudText>
        <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-3">
            Based on plan: @_execution.Plan?.Name
        </MudText>
        
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" 
                 ActivePanelIndex="@_activeTabIndex" 
                 ActivePanelIndexChanged="@((int index) => _activeTabIndex = index)"
                 Class="mb-3">
            <MudTabPanel Text="Technician View" Icon="@Icons.Material.Filled.Engineering">
                <TechnicianView 
                    Execution="@_execution"
                    CurrentStepId="@_currentStep?.Id"
                    OnStartStep="@StartStep"
                    OnCompleteStep="@CompleteStep"
                    OnExpandDetails="@OpenStepDetailsDialog" />
            </MudTabPanel>
            
            <MudTabPanel Text="Overview" Icon="@Icons.Material.Filled.Dashboard">
                <OverviewView 
                    Execution="@_execution"
                    CurrentStepId="@_currentStep?.Id"
                    CurrentUser="@_currentUser"
                    OnActivityClick="@OpenStepDetailsDialog"
                    OnApprove="@ApproveGoNoGo"
                    OnReject="@RejectGoNoGo" />
            </MudTabPanel>
        </MudTabs>
    </MudContainer>
    
    @* Step Details Dialog *@
    <MudDialog @bind-Visible="_detailsDialogVisible" Options="_dialogOptions">
        <TitleContent>
            <MudText Typo="Typo.h6">Step @_detailsStep?.Order: @_detailsStep?.Name</MudText>
        </TitleContent>
        <DialogContent>
            @if (_detailsStep != null)
            {
                <MudTextField 
                    @bind-Value="_detailsStep.ResultSummary"
                    Label="Result Summary"
                    Lines="3"
                    Variant="Variant.Outlined"
                    Class="mb-3" />
                
                <MudTextField 
                    @bind-Value="_detailsStep.WhatWentWell"
                    Label="What Went Well"
                    Lines="3"
                    Variant="Variant.Outlined"
                    Class="mb-3" />
                
                <MudTextField 
                    @bind-Value="_detailsStep.WhatCouldBeBetter"
                    Label="What Could Be Better"
                    Lines="3"
                    Variant="Variant.Outlined"
                    Class="mb-3" />
                
                <MudText Typo="Typo.subtitle2" Class="mb-2">Screenshot</MudText>
                <ScreenshotUploader @bind-ImageData="_detailsStep.ResultScreenshot" />
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseDetailsDialog">Cancel</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveStepDetails">
                Save
            </MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [Parameter]
    public int? Id { get; set; }
    
    [Parameter]
    public int? PlanId { get; set; }
    
    private Execution? _execution;
    private ExecutionStep? _currentStep;
    private ExecutionMember? _currentUser;
    private int _activeTabIndex = 0;
    
    // Details dialog
    private bool _detailsDialogVisible = false;
    private ExecutionStep? _detailsStep;
    
    private DialogOptions _dialogOptions = new() 
    { 
        MaxWidth = MaxWidth.Large, 
        FullWidth = true,
        CloseButton = true
    };
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (PlanId.HasValue)
            {
                _execution = await ExecutionService.CreateExecutionFromPlanAsync(PlanId.Value);
                if (_execution != null)
                {
                    Id = _execution.Id;
                    NavigationManager.NavigateTo($"/executions/{Id}", replace: true);
                }
                else
                {
                    NavigationManager.NavigateTo("/plans");
                    Snackbar.Add("Failed to create execution", Severity.Error);
                    return;
                }
            }
            else if (Id.HasValue)
            {
                _execution = await ExecutionService.GetExecutionAsync(Id.Value);
                if (_execution == null)
                {
                    NavigationManager.NavigateTo("/executions");
                    Snackbar.Add("Execution not found", Severity.Error);
                    return;
                }
            }
            
            if (_execution != null)
            {
                InitializeView();
            }
        }
        catch (InvalidOperationException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
            NavigationManager.NavigateTo("/plans");
        }
    }
    
    private void InitializeView()
    {
        // Find current step (first incomplete step)
        _currentStep = _execution!.Steps
            .OrderBy(s => s.Order)
            .FirstOrDefault(s => !s.CompleteOn.HasValue && !s.IsCancelled);

        if (_currentStep == null)
        {
            _currentStep = _execution.Steps.OrderBy(s => s.Order).LastOrDefault();
        }

        // Simulate current user (first member for demo)
        _currentUser = _execution.Members.FirstOrDefault();

        // Determine default tab based on whether user is assigned to any activity steps
        var isAssignedToActivities = _execution.Steps
            .Any(s => s.StepType == StepType.Activity && 
                     s.AssignedMembers.Any(m => m.Id == _currentUser?.Id));

        _activeTabIndex = isAssignedToActivities ? 0 : 1; // 0 = Technician, 1 = Overview
    }
    
    private async Task HandleTimelineStepClick(ExecutionStep step)
    {
        _currentStep = step;
        StateHasChanged();
    }
    
    private async Task StartStep(ExecutionStep step)
    {
        step.StartedOn = DateTime.Now;
        await ExecutionService.UpdateExecutionStepAsync(step);
        _currentStep = step;
        Snackbar.Add($"Step {step.Order} started", Severity.Info);
        StateHasChanged();
    }
    
    private async Task CompleteStep(ExecutionStep step)
    {
        step.CompleteOn = DateTime.Now;
        await ExecutionService.UpdateExecutionStepAsync(step);
        Snackbar.Add($"Step {step.Order} completed", Severity.Success);

        // Move to next step
        var nextStep = _execution!.Steps
            .OrderBy(s => s.Order)
            .FirstOrDefault(s => !s.CompleteOn.HasValue && !s.IsCancelled && s.Order > step.Order);

        if (nextStep != null)
        {
            _currentStep = nextStep;
        }

        StateHasChanged();
    }
    
    private void OpenStepDetailsDialog(ExecutionStep step)
    {
        _detailsStep = step;
        _detailsDialogVisible = true;
    }
    
    private void CloseDetailsDialog()
    {
        _detailsDialogVisible = false;
        _detailsStep = null;
    }
    
    private async Task SaveStepDetails()
    {
        if (_detailsStep != null)
        {
            await ExecutionService.UpdateExecutionStepAsync(_detailsStep);
            Snackbar.Add("Step details saved", Severity.Success);
        }
        CloseDetailsDialog();
        StateHasChanged();
    }
    
    private async Task ApproveGoNoGo(ExecutionStep step)
    {
        if (_currentUser == null) return;
        
        var approval = step.Approvals.FirstOrDefault(a => a.ExecutionMemberId == _currentUser.Id);
        if (approval == null) return;
        
        var parameters = new DialogParameters
        {
            { "ContentText", "Add any comments about your approval decision:" },
            { "ButtonText", "Approve" },
            { "Color", Color.Success }
        };
        
        var dialog = await DialogService.ShowMessageBox(
            "Approve Milestone",
            "Are you sure you want to approve this Go/No-Go checkpoint?",
            yesText: "Approve", cancelText: "Cancel");
        
        if (dialog == true)
        {
            approval.IsApproved = true;
            approval.ApprovalDate = DateTime.Now;
            await ExecutionService.UpdateExecutionStepAsync(step);

            // Check if all approvals are complete
            if (step.Approvals.All(a => a.IsApproved.HasValue && a.IsApproved.Value))
            {
                step.CompleteOn = DateTime.Now;
                await ExecutionService.UpdateExecutionStepAsync(step);
                Snackbar.Add("Milestone approved and completed!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Your approval has been recorded", Severity.Success);
            }

            StateHasChanged();
        }
    }
    
    private async Task RejectGoNoGo(ExecutionStep step)
    {
        if (_currentUser == null) return;
        
        var approval = step.Approvals.FirstOrDefault(a => a.ExecutionMemberId == _currentUser.Id);
        if (approval == null) return;
        
        var dialog = await DialogService.ShowMessageBox(
            "Reject Milestone",
            "Are you sure you want to reject this Go/No-Go checkpoint? This may require fallback actions.",
            yesText: "Reject", cancelText: "Cancel");
        
        if (dialog == true)
        {
            approval.IsApproved = false;
            approval.ApprovalDate = DateTime.Now;
            await ExecutionService.UpdateExecutionStepAsync(step);
            Snackbar.Add("Milestone rejected", Severity.Warning);
            StateHasChanged();
        }
    }
}

