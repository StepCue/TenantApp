@page "/plans/new"
@page "/plans/{Id:int}"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using StepCue.TenantApp.Core.Services
@using StepCue.TenantApp.Data.Models
@using StepCue.TenantApp.Data.Models.Planning
@using StepCue.TenantApp.Web.Components.Shared
@using StepCue.TenantApp.Web.Services
@inject PlanService PlanService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<style>
    .plan-editor-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 24px;
        height: calc(100vh - 120px);
    }

    @@media (max-width: 960px) {
        .plan-editor-container {
            grid-template-columns: 1fr;
            height: auto;
        }
    }

    .steps-section {
        overflow-y: auto;
        padding-right: 8px;
    }

    .steps-grid {
        display: grid;
        gap: 16px;
    }

    .quick-add-section {
        position: sticky;
        bottom: 0;
        background-color: var(--mud-palette-background);
        padding: 16px 0;
        border-top: 2px solid var(--mud-palette-divider);
        margin-top: 16px;
    }

    .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--mud-palette-text-secondary);
    }

    .empty-state-icon {
        font-size: 64px;
        opacity: 0.3;
        margin-bottom: 16px;
    }
</style>

<PageTitle>@(_isNewPlan ? "Create Plan" : "Edit Plan")</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 mb-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo="Typo.h4">@(_isNewPlan ? "Create Plan" : "Edit Plan")</MudText>
            <MudBreadcrumbs Items="_breadcrumbs" Class="mt-1"></MudBreadcrumbs>
        </div>
        <div class="d-flex gap-2">
            <MudButton 
                Variant="Variant.Outlined" 
                Color="Color.Secondary" 
                OnClick="@(() => NavigationManager.NavigateTo("/plans"))">
                Cancel
            </MudButton>
            <MudButton 
                Variant="Variant.Filled" 
                Color="Color.Primary" 
                StartIcon="@Icons.Material.Filled.Save"
                OnClick="SavePlan">
                Save Plan
            </MudButton>
        </div>
    </div>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudForm Model="@_plan" @ref="_form">
            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudTextField 
                    @bind-Value="_plan.Name" 
                    Label="Plan Name" 
                    Variant="Variant.Outlined"
                    Required="true" 
                    RequiredError="Plan name is required"
                    Immediate="true"
                    Placeholder="Enter a descriptive name for this plan..." />
            </MudPaper>

            <MudPaper Elevation="2" Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">Team Members</MudText>
                <MemberManager Members="@_plan.Members" />
            </MudPaper>

            <div class="plan-editor-container">
                <div class="steps-section">
                    <div class="d-flex justify-space-between align-center mb-3">
                        <MudText Typo="Typo.h6">Plan Steps (@_orderedSteps.Count)</MudText>
                    </div>

                    @if (!_plan.Steps.Any())
                    {
                        <MudPaper Elevation="0" Class="empty-state">
                            <div class="empty-state-icon">
                                <MudIcon Icon="@Icons.Material.Filled.ListAlt" />
                            </div>
                            <MudText Typo="Typo.h6" Class="mb-2">No steps yet</MudText>
                            <MudText Typo="Typo.body2" Class="mb-4">
                                Get started by adding your first step below
                            </MudText>
                            <MudButton 
                                Variant="Variant.Filled" 
                                Color="Color.Primary" 
                                StartIcon="@Icons.Material.Filled.Add"
                                Size="Size.Large"
                                OnClick="AddStep">
                                Add First Step
                            </MudButton>
                        </MudPaper>
                    }
                    else
                    {
                        <div class="steps-grid">
                            @for (int i = 0; i < _orderedSteps.Count; i++)
                            {
                                var step = _orderedSteps[i];
                                var index = i;
                                <StepCard 
                                    Step="@step"
                                    AvailableMembers="@_plan.Members"
                                    CanMoveUp="@(index > 0)"
                                    CanMoveDown="@(index < _orderedSteps.Count - 1)"
                                    IsSelected="@(_selectedStep?.Id == step.Id)"
                                    IsFlashing="@(ReferenceEquals(_flashingStep, step))"
                                    OnMoveUp="@MoveStepUp"
                                    OnMoveDown="@MoveStepDown"
                                    OnDelete="@RemoveStep"
                                    OnEditMore="@OpenStepDetailsDialog"
                                    OnSave="@((s) => StateHasChanged())"
                                    OnSelect="@((s) => _selectedStep = s)"
                                    OnAddNewMember="@AddMemberFromStep"
                                    OnInsertAbove="@InsertStepAbove"
                                    OnInsertBelow="@InsertStepBelow" />
                            }
                        </div>

                        <div class="quick-add-section">
                            <MudButton 
                                Variant="Variant.Outlined" 
                                Color="Color.Primary" 
                                StartIcon="@Icons.Material.Filled.Add"
                                FullWidth="true"
                                Size="Size.Large"
                                OnClick="AddStep">
                                Add Step
                            </MudButton>
                        </div>
                    }
                </div>

                <div>
                    <PlanTimelineOverview 
                        Steps="@_orderedSteps" 
                        SelectedStepId="@_selectedStep?.Id"
                        OnStepClick="@ScrollToAndFlashStep" />
                </div>
            </div>
        </MudForm>
    }
</MudContainer>

<!-- Step Details Dialog -->
<MudDialog @bind-Visible="_stepDetailsDialogVisible" Options="@_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h5">Step Details - @(_selectedStep?.Name ?? "Untitled")</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedStep != null)
        {
            <StepEditorPopup 
                Step="_selectedStep" 
                PlanMembers="_plan.Members" 
                PlanSteps="_plan.Steps" 
                OnSave="@SaveStepDetails" 
                OnCancel="@CloseStepDetailsDialog" />
        }
    </DialogContent>
</MudDialog>



@code {
    [Parameter]
    public int? Id { get; set; }

    private Plan _plan = new Plan();
    private bool _isNewPlan => Id == null;
    private bool _isLoading = true;
    private MudForm _form = default!;

    private List<PlanStep> _orderedSteps => _plan.Steps.OrderBy(s => s.Order).ToList();
    private bool _stepDetailsDialogVisible = false;
    private PlanStep? _selectedStep;
    private PlanStep? _flashingStep;
    private System.Threading.Timer? _flashTimer;

    private DialogOptions _dialogOptions = new DialogOptions 
    { 
        MaxWidth = MaxWidth.ExtraLarge, 
        FullWidth = true,
        CloseButton = true
    };

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Plans", href: "/plans"),
        new BreadcrumbItem("Editor", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        if (!_isNewPlan)
        {
            var plan = await PlanService.GetPlanAsync(Id.Value);
            if (plan != null)
            {
                _plan = plan;
            }
            else
            {
                NavigationManager.NavigateTo("/plans");
                Snackbar.Add("Plan not found", Severity.Error);
            }
        }
        else
        {
            _plan.Name = "New Plan";
            await PlanService.CreatePlanAsync(_plan);
            Snackbar.Add("Plan created successfully", Severity.Success);
        }

        _isLoading = false;
    }

    private void SortStepsCollection()
    {
        var sortedSteps = _plan.Steps.OrderBy(s => s.Order).ToList();
        _plan.Steps.Clear();
        foreach (var step in sortedSteps)
        {
            _plan.Steps.Add(step);
        }
    }

    private void AddStep()
    {
        var newOrder = _plan.Steps.Any() ? _plan.Steps.Max(s => s.Order) + 1 : 1;
        var newStep = new PlanStep 
        { 
            Order = newOrder,
            Name = string.Empty
        };
        _plan.Steps.Add(newStep);
        _selectedStep = newStep;
        SortStepsCollection();
        StateHasChanged();
    }

    private void InsertStepBelow(PlanStep currentStep)
    {
        var currentOrder = currentStep.Order;

        // Increment order of all steps after this one
        foreach (var step in _plan.Steps.Where(s => s.Order > currentOrder))
        {
            step.Order++;
        }

        var newStep = new PlanStep 
        { 
            Order = currentOrder + 1,
            Name = string.Empty
        };
        _plan.Steps.Add(newStep);
        _selectedStep = newStep;
        SortStepsCollection();
        StateHasChanged();
    }

    private void InsertStepAbove(PlanStep currentStep)
    {
        var currentOrder = currentStep.Order;

        // Increment order of this step and all steps after it
        foreach (var step in _plan.Steps.Where(s => s.Order >= currentOrder))
        {
            step.Order++;
        }

        var newStep = new PlanStep 
        { 
            Order = currentOrder,
            Name = string.Empty
        };
        _plan.Steps.Add(newStep);
        _selectedStep = newStep;
        SortStepsCollection();
        StateHasChanged();
    }

    private void MoveStepUp(PlanStep step)
    {
        var currentIndex = _orderedSteps.IndexOf(step);
        if (currentIndex > 0)
        {
            var previousStep = _orderedSteps[currentIndex - 1];
            (step.Order, previousStep.Order) = (previousStep.Order, step.Order);
            SortStepsCollection();
            StateHasChanged();
        }
    }

    private void MoveStepDown(PlanStep step)
    {
        var currentIndex = _orderedSteps.IndexOf(step);
        if (currentIndex < _orderedSteps.Count - 1)
        {
            var nextStep = _orderedSteps[currentIndex + 1];
            (step.Order, nextStep.Order) = (nextStep.Order, step.Order);
            SortStepsCollection();
            StateHasChanged();
        }
    }

    private async Task RemoveStep(PlanStep step)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Step",
            $"Are you sure you want to delete '{step.Name}'?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            _plan.Steps.Remove(step);

            // Reorder remaining steps
            var orderedSteps = _plan.Steps.OrderBy(s => s.Order).ToList();
            for (int i = 0; i < orderedSteps.Count; i++)
            {
                orderedSteps[i].Order = i + 1;
            }

            if (_selectedStep?.Id == step.Id)
            {
                _selectedStep = null;
            }

            SortStepsCollection();
            StateHasChanged();
        }
    }

    private async Task SavePlan()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var stepsWithoutNames = _plan.Steps.Where(s => string.IsNullOrWhiteSpace(s.Name)).ToList();
            if (stepsWithoutNames.Any())
            {
                Snackbar.Add("All steps must have names before saving", Severity.Warning);
                return;
            }

            await PlanService.UpdatePlanAsync(_plan);
            Snackbar.Add("Plan saved successfully", Severity.Success);
            NavigationManager.NavigateTo("/plans");
        }
    }

    private void OpenStepDetailsDialog(PlanStep step)
    {
        _selectedStep = step;
        _stepDetailsDialogVisible = true;
    }

    private void CloseStepDetailsDialog()
    {
        _stepDetailsDialogVisible = false;
        StateHasChanged();
    }

    private async Task SaveStepDetails()
    {
        CloseStepDetailsDialog();
        StateHasChanged();
    }

    private void SwitchToStepInDialog(PlanStep step)
    {
        _selectedStep = step;
        StateHasChanged();
    }

    private async Task AddMemberFromStep(PlanStep step)
    {
        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true,
            BackdropClick = false
        };
        var dialog = await DialogService.ShowAsync<AddMemberDialog>("Add New Member", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string memberName && !string.IsNullOrWhiteSpace(memberName))
        {
            var newMember = new PlanMember { Name = memberName };
            _plan.Members.Add(newMember);

            // Automatically assign the new member to the step
            if (!step.AssignedMembers.Contains(newMember))
            {
                step.AssignedMembers.Add(newMember);
            }

            Snackbar.Add($"Member '{memberName}' added and assigned to step", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task ScrollToAndFlashStep(PlanStep step)
    {
        _selectedStep = step;
        _flashingStep = step;
        StateHasChanged();

        // Clear flash after 800ms (matching animation duration)
        _flashTimer?.Dispose();
        _flashTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                _flashingStep = null;
                StateHasChanged();
            });
        }, null, 800, System.Threading.Timeout.Infinite);
    }
}