@page "/plans"
@using StepCue.TenantApp.Core.Services
@using StepCue.TenantApp.Data.Models.Planning
@using StepCue.TenantApp.Web.Services
@inject PlanService PlanService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Plans</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Plans</MudText>
    
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
               OnClick="@CreateNewPlan">
        Create New Plan
    </MudButton>
    
    <MudDivider Class="my-4" />
    
    @if (_plans == null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (!_plans.Any())
    {
        <MudText>No plans found. Create your first plan.</MudText>
    }
    else
    {
        <MudGrid>
            @foreach (var plan in _plans)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@plan.Name</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText>@plan.Steps.Count steps</MudText>
                            <MudText>@plan.Members.Count members</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" 
                                      OnClick="@(() => NavigationManager.NavigateTo($"/plans/{plan.Id}"))">
                                Edit
                            </MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Success" 
                                      OnClick="@(() => ExecutePlan(plan.Id))">
                                Execute
                            </MudButton>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" 
                                         OnClick="@(() => ConfirmDelete(plan))"/>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private List<Plan> _plans;
    private bool _createPlanDialogVisible = false;
    private string _newPlanName = "";

    protected override async Task OnInitializedAsync()
    {
        _plans = await PlanService.GetPlansAsync();
    }

    private void CreateNewPlan()
    {
        _newPlanName = "";
        _createPlanDialogVisible = true;
    }

    private void CancelCreatePlan()
    {
        _createPlanDialogVisible = false;
        _newPlanName = "";
    }

    private async Task ConfirmCreatePlan()
    {
        if (!string.IsNullOrWhiteSpace(_newPlanName))
        {
            var newPlan = await PlanService.CreateNewPlanAsync(_newPlanName.Trim());
            _createPlanDialogVisible = false;
            _newPlanName = "";
            NavigationManager.NavigateTo($"/plans/{newPlan.Id}");
        }
    }

    private async Task OnPlanNameKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newPlanName))
        {
            await ConfirmCreatePlan();
        }
    }

    private async Task ExecutePlan(int planId)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Execute Plan",
            "Are you sure you want to execute this plan? This will create a new execution.",
            yesText: "Execute", cancelText: "Cancel");
            
        if (result == true)
        {
            NavigationManager.NavigateTo($"/executions/create/{planId}");
        }
    }

    private async Task ConfirmDelete(Plan plan)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Plan",
            $"Are you sure you want to delete plan '{plan.Name}'?",
            yesText: "Delete", cancelText: "Cancel");
            
        if (result == true)
        {
            await PlanService.DeletePlanAsync(plan.Id);
            _plans.Remove(plan);
            StateHasChanged();
        }
    }
}

<!-- Plan Name Dialog -->
<MudDialog @bind-Visible="_createPlanDialogVisible" Options="@(new DialogOptions() { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h5">Create New Plan</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_newPlanName" 
                     Label="Plan Name" 
                     Placeholder="Enter plan name..."
                     Required="true"
                     RequiredError="Plan name is required"
                     Variant="Variant.Outlined"
                     Margin="Margin.Dense"
                     FullWidth="true"
                     @onkeypress="OnPlanNameKeyPress" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelCreatePlan" 
                   Variant="Variant.Text" 
                   Color="Color.Secondary">
            Cancel
        </MudButton>
        <MudButton OnClick="ConfirmCreatePlan" 
                   Variant="Variant.Filled" 
                   Color="Color.Primary"
                   Disabled="@string.IsNullOrWhiteSpace(_newPlanName)">
            Create Plan
        </MudButton>
    </DialogActions>
</MudDialog>